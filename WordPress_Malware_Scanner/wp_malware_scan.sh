#!/usr/bin/env bash
#
# WordPress Malware Scanner v2.3 (2025-05-18)
# by Jason Tools (æ­é… AI å”åŠ©)
# -------------------------------------------------
# - å¤šç¶­åº¦é¢¨éšªè©•åˆ†ï¼ˆå¯èª¿ MIN_RISK_SHOWï¼‰
# - å®˜æ–¹ MD5 é›œæ¹Šæ¯”å°ï¼ˆå®Œæ•´è·¯å¾‘ï¼‹basenameï¼‰
# - ä»¥ Tab ç‚ºæ¬„ä½åˆ†éš”ï¼Œæª”åå¯å«ç©ºæ ¼
# -------------------------------------------------

###################### ä½¿ç”¨è€…èª¿æ•´å€ ######################
MIN_RISK_SHOW=9                                  # é¢¨éšªé–€æª»
TARGET_PATH="${1:-$(pwd)}"                       # æƒæç›®éŒ„
OUTPUT_DIR="./wp_scan_results"                   # è¼¸å‡ºè³‡æ–™å¤¾
#########################################################

DELIM=$'\t'                                      # æ¬„ä½åˆ†éš” (Tab)
SUSPICIOUS_FILES="$OUTPUT_DIR/suspicious_files.txt"
HIGH_RISK_RAW="$OUTPUT_DIR/high_risk_raw.txt"    # æ ¼å¼ï¼šscore<Tab>filepath
REPORT_TXT="$OUTPUT_DIR/detailed_report.txt"

mkdir -p "$OUTPUT_DIR"
:> "$SUSPICIOUS_FILES"  :> "$HIGH_RISK_RAW"

echo "==> æƒæç›®æ¨™ï¼š$TARGET_PATH"
echo "==> çµæœè¼¸å‡ºï¼š$OUTPUT_DIR"
echo

###################### 1. æœå°‹å¯ç–‘æª” ######################
scan_pattern(){ grep -R --include="*.php*" -l -E "$1" "$TARGET_PATH" 2>/dev/null; }

echo "[1/4] æœå°‹å¯ç–‘ç¨‹å¼ç¢¼â€¦"
scan_pattern "eval|base64_decode|gzinflate|str_rot13|assert|system|exec|shell_exec|passthru|popen|preg_replace.*e|create_function|include.*\\$_|require.*\\$_|_POST|_GET|_REQUEST|_COOKIE|_SERVER\\[\"HTTP_|_FILES|move_uploaded_file|copy.*tmp_name|file_put_contents|file_get_contents.*http|fsockopen|stream_socket_client|curl|proc_open|posix_" >>"$SUSPICIOUS_FILES"
scan_pattern "FilesMan|WSO|c99|r57|weevely|webshell|b374k|meterpreter|reverse shell|bind shell|adminer" >>"$SUSPICIOUS_FILES"
scan_pattern "\\\\x[0-9a-fA-F]{2}"   >>"$SUSPICIOUS_FILES"
scan_pattern "chr\\([0-9]"           >>"$SUSPICIOUS_FILES"
scan_pattern "goto "                 >>"$SUSPICIOUS_FILES"

find "$TARGET_PATH" -type f -name "*.php*" -size -2k \
     -exec grep -l "_FILES\\|move_uploaded_file\\|copy.*tmp_name" {} + 2>/dev/null >>"$SUSPICIOUS_FILES"
find "$TARGET_PATH" -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.gif" \
      -o -iname "*.jpeg" -o -iname "*.pdf" -o -iname "*.txt" -o -iname "*.ico" \) \
     -exec grep -l "<?php" {} + 2>/dev/null >>"$SUSPICIOUS_FILES"
find "$TARGET_PATH" -type f -name ".*php*" 2>/dev/null >>"$SUSPICIOUS_FILES"

for dir in wp-content/uploads wp-content/cache wp-content/tmp wp-content/upgrade; do
  [ -d "$TARGET_PATH/$dir" ] && find "$TARGET_PATH/$dir" -name "*.php" 2>/dev/null >>"$SUSPICIOUS_FILES"
done

scan_pattern "<\\?(php)?\\s*.{1,200};\\s*\\?>" >>"$SUSPICIOUS_FILES"
scan_pattern "<title>.*[Vv]uln.*patch.*[Nn]ow.*</title>.*<\\?php" >>"$SUSPICIOUS_FILES"

sort -u "$SUSPICIOUS_FILES" -o "$SUSPICIOUS_FILES"
echo "    â†’ åˆæ­¥å¯ç–‘æª”æ¡ˆï¼š$(wc -l <"$SUSPICIOUS_FILES") å€‹"
echo

################ 2. å®˜æ–¹ MD5 é›œæ¹Šæ’é™¤ ################
echo "[2/4] å®˜æ–¹ MD5 é›œæ¹Šæ¯”å°â€¦"
WP_VERSION=""

if [ -f "$TARGET_PATH/wp-includes/version.php" ]; then
  WP_VERSION=$(awk -F"'" '/^\$wp_version/ {print $2; exit}' "$TARGET_PATH/wp-includes/version.php")
elif [ -f "$TARGET_PATH/wp-admin/includes/update-core.php" ]; then
  WP_VERSION=$(awk -F"'" '/^\$wp_version/ {print $2; exit}' "$TARGET_PATH/wp-admin/includes/update-core.php")
fi

if [ -z "$WP_VERSION" ]; then
  echo "âš ï¸  æŠ“ä¸åˆ° WordPress ç‰ˆæœ¬ï¼Œè·³éé›œæ¹Šæ¯”å°"
else
  WP_LOCALE=$(awk -F"'" '/define *\('"'"'WPLANG'"'"'/ {print $4}' "$TARGET_PATH/wp-config.php" 2>/dev/null)
  [ -z "$WP_LOCALE" ] && WP_LOCALE="en_US"
  echo "    â†’ ç‰ˆæœ¬/èªç³»ï¼š$WP_VERSION / $WP_LOCALE"

  CHECKSUM_JSON=$(curl -fsSL "https://api.wordpress.org/core/checksums/1.0/?version=${WP_VERSION}&locale=${WP_LOCALE}")
  if [ $? -eq 0 ] && [ -n "$CHECKSUM_JSON" ]; then
    TMP_CS=$(mktemp)
    echo "$CHECKSUM_JSON" | jq -r 'to_entries[] | "\(.key) \(.value)"' >"$TMP_CS"
    TMP_FILTER=$(mktemp)

    while IFS= read -r FILE_PATH; do
      REL="${FILE_PATH#$TARGET_PATH/}"           # ç›¸å°è·¯å¾‘
      BASE=$(basename "$REL")

      EXPECTED_MD5=$(awk -v rel="$REL" '$1==rel{print $2; exit}' "$TMP_CS")
      [ -z "$EXPECTED_MD5" ] && EXPECTED_MD5=$(awk -v base="$BASE" '$1~"/"base"$"{print $2; exit}' "$TMP_CS")

      if [ -n "$EXPECTED_MD5" ]; then
        CALC_MD5=$(md5sum "$FILE_PATH" | awk '{print $1}')
        if [ "$CALC_MD5" = "$EXPECTED_MD5" ]; then
          echo "    âœ…  æ’é™¤å®˜æ–¹æ ¸å¿ƒæª”ï¼š$REL"
          continue
        fi
      fi
      echo "$FILE_PATH" >>"$TMP_FILTER"
    done <"$SUSPICIOUS_FILES"

    mv "$TMP_FILTER" "$SUSPICIOUS_FILES"
    rm -f "$TMP_CS"
  else
    echo "âš ï¸  é›œæ¹Šä¸‹è¼‰å¤±æ•—ï¼Œè·³éæ¯”å°"
  fi
fi

sort -u "$SUSPICIOUS_FILES" -o "$SUSPICIOUS_FILES"
total_count=$(wc -l <"$SUSPICIOUS_FILES")
echo "    â†’ æ¯”å°å¾Œå‰©é¤˜å¯ç–‘æª”æ¡ˆï¼š$total_count å€‹"
echo

###################### 3. é¢¨éšªè©•åˆ† ######################
echo "[3/4] é¢¨éšªè©•åˆ†â€¦  (é–€æª» = $MIN_RISK_SHOW)"

while IFS= read -r file; do
  [ ! -f "$file" ] && continue
  score=0

  grep -Eq "eval.*(base64_decode|gzinflate|str_rot13)" "$file" && score=$((score+6))
  grep -Eq "(system|exec|shell_exec|passthru|popen).*?\\$[_A-Z]+" "$file" && score=$((score+5))
  grep -Eiq "(FilesMan|WSO|c99|r57|weevely|webshell)" "$file" && score=$((score+5))
  grep -Eq "\\\\x[0-9a-fA-F]{2}|chr\\([0-9]" "$file" && score=$((score+4))
  grep -Eq "move_uploaded_file|copy.*_FILES.*'tmp_name'" "$file" && score=$((score+3))
  grep -Eq "<\\?(php)?\\s*.{1,200};\\s*\\?>" "$file" && score=$((score+3))
  case "$file" in *.jpg|*.png|*.gif|*.jpeg|*.pdf|*.txt|*.ico) grep -q "<?php" "$file" && score=$((score+3));; esac
  [[ $(basename "$file") == .*php* ]] && score=$((score+2))
  [[ "$file" == *"/wp-content/uploads/"* || "$file" == *"/wp-content/cache/"* || "$file" == *"/wp-content/tmp/"* ]] && score=$((score+2))
  grep -Eq "(eval|assert|system|exec|shell_exec|passthru|popen)" "$file" && score=$((score+2))

  [ $score -ge $MIN_RISK_SHOW ] && printf "%d${DELIM}%s\n" "$score" "$file" >>"$HIGH_RISK_RAW"
done <"$SUSPICIOUS_FILES"

###################### 4. ç”¢å‡ºå ±å‘Š ######################
echo "[4/4] ç”¢å‡ºå ±å‘Šâ€¦"
sort -nr -t"$DELIM" -k1,1 "$HIGH_RISK_RAW" >"$OUTPUT_DIR/high_risk_sorted.txt"
high_risk_count=$(wc -l <"$OUTPUT_DIR/high_risk_sorted.txt")

{
echo "WordPress å®‰å…¨æƒæå ±å‘Š"
echo "======================="
echo "æƒææ™‚é–“: $(date)"
echo "æƒæç›®æ¨™: $TARGET_PATH"
echo "å‰©é¤˜å¯ç–‘æª”æ¡ˆ: $total_count"
echo "åˆ—å‡ºé–€æª» (MIN_RISK_SHOW): $MIN_RISK_SHOW"
echo "-----------------------"
echo "â˜… é«˜é¢¨éšªæª”æ¡ˆ (å…± $high_risk_count å€‹ï¼Œåˆ†æ•¸é«˜â†’ä½)"
echo
awk -F"$DELIM" '{printf "%3d åˆ†  %s\n",$1,$2}' "$OUTPUT_DIR/high_risk_sorted.txt"
} >"$REPORT_TXT"

echo
echo "ğŸš© å ±å‘Šå·²è¼¸å‡ºåˆ° $REPORT_TXT"
[ $high_risk_count -gt 0 ] && echo "ğŸš© ç¬¦åˆé–€æª»çš„é«˜é¢¨éšªæª”ï¼š$high_risk_count å€‹"
